#!/bin/bash

ClusterYamlFile=/apps/slurm/scripts/cluster.yaml
SlurmConfTemplateFile=/apps/slurm/scripts/slurm.conf.template

ClusterJson=$(yq -jP r - < "$ClusterYamlFile")
SlurmConfJson=$(echo "$ClusterJson" | jq '.[].SlurmConf')
(echo "$SlurmConfJson" | jq -r 'keys[] as $k | "export \($k)=\(.[$k])"' ; echo "envsubst < ${SlurmConfTemplateFile}") | bash

AllPartitionJson=$(echo "$ClusterJson" | jq -r '.[].Partitions')

Partitions="DEFAULT $(echo "$AllPartitionJson" | jq -r 'keys[]' | grep -v 'DEFAULT' | xargs)"

for p in $Partitions
do
	PartitionJson=$(echo "$AllPartitionJson" | jq -r ".${p}")
	(echo PartitionName="$p"; echo "$PartitionJson" | jq -r '. | select(.PartitionParameters != null) | .PartitionParameters | keys[] as $k | "\($k)=\(.[$k])"' )| xargs

	NodeJson=$(echo "$PartitionJson" | jq -r '.Nodes')
	echo "$NodeJson" | jq -r '.[] as $p | $p | keys[] as $k | "\($k)=\(.[$k])"' | xargs
	echo ""
done


